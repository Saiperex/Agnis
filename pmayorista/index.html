<!DOCTYPE html>
<html>
<head>
    <title>Cruce de Datos y Handsontable</title>
    <link rel="stylesheet" href="node_modules/handsontable/dist/handsontable.full.css">
    <script src="node_modules/handsontable/dist/handsontable.full.js"></script>
    <script src="node_modules/xlsx/xlsx.js"></script>
</head>
<body>
    <input type="file" id="archivo" accept=".xlsx" />
    <button id="cargarBtn">Cargar Hoja de Cálculo</button>
    <button id="descargarBtn" style="display: none;">Descargar Archivo Modificado</button>
    <div id="handsontable"></div>

    <script>
        let datos;
        var hot=null;
        const propToIndex = {
            "Artículo": 0,
            "Descripción": 1,
            "UOM": 2,
            "Cantidad por paquete": 3,
            "Esperado": 4,
            "Recibido": 5,
            "Dañado": 6,
            "Fuera de Stock": 7
        };
        
        document.getElementById('archivo').addEventListener('change', function (e) {
            const archivo = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                datos = XLSX.utils.sheet_to_json(worksheet);
            };

            reader.readAsArrayBuffer(archivo);
        });

        function mostrarDatosEnHandsontable(datos) {
            const container = document.getElementById('handsontable');
             hot = new Handsontable(container, {
                data: datos,
                colHeaders: ["Artículo", "Descripción", "UOM", "Cantidad por paquete", "Esperado", "Recibido", "Dañado", "Fuera de Stock"],
                rowHeaders: true,
                columnSorting: true,
                licenseKey: 'non-commercial-and-evaluation',
            });

            hot.addHook('afterChange', function (changes) {
                // El evento afterChange se activa cuando se realizan cambios en Handsontable
                changes.forEach(function (change) {
                    // change contiene [row, prop, oldVal, newVal]
                    // Actualiza los datos originales con los cambios
                    datos[change[0]][propToIndex[change[1]]] = change[3];
                });
            });
        }

        document.getElementById('cargarBtn').addEventListener('click', function () {
            if (datos) {
                // Elimina las filas de la 1 a la 15 y las que contienen "Container ID" o "Estado"
                datos = eliminarFilasIndeseadas(datos);
                mostrarDatosEnHandsontable(datos);
                document.getElementById('descargarBtn').style.display = 'block';
            }
        });

        function eliminarFilasIndeseadas(datos) {
            // Filtrar las filas cuya primera columna contenga solo números
            datos = datos.filter((fila) => {
                const primeraColumna = fila[Object.keys(fila)[0]]; // Obtiene el valor de la primera columna
                return !isNaN(primeraColumna); // Verifica si es un número
            });
            return datos;
        }

        document.getElementById('descargarBtn').addEventListener('click', function () {
            const datos2=hot.getData()
            if (datos2) {
                const nuevoWorkbook = XLSX.utils.book_new();
                
                // Crear una hoja de cálculo con la fila de título personalizada
                const titulos = ["Artículo", "Descripción", "UOM", "Cantidad por paquete", "Esperado", "Recibido", "Dañado", "Fuera de Stock"];
                const nuevaHoja = XLSX.utils.json_to_sheet([titulos], { skipHeader: true });
                
                // Agregar los datos debajo de la fila de título
                XLSX.utils.sheet_add_json(nuevaHoja, datos2, { skipHeader: true, origin: 1 });
                
                XLSX.utils.book_append_sheet(nuevoWorkbook, nuevaHoja, "Datos Modificados");
                XLSX.writeFile(nuevoWorkbook, "datos_modificados.xlsx");
            }
        });

    </script>
</body>
</html>
